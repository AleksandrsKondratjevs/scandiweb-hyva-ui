<?php

/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\ProductListItem;
use Hyva\Theme\ViewModel\ProductPage;
use Hyva\Theme\ViewModel\Store;
use Magento\Catalog\Block\Product\ReviewRendererInterface as ProductReviewRenderer;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

// phpcs:disable Generic.Files.LineLength.TooLong

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** @var Store $viewModelStore */
$viewModelStore = $viewModels->require(Store::class);

/** @var ProductPage $productViewModel */
$productViewModel = $viewModels->require(ProductPage::class);

/** @var HeroiconsOutline $heroicons */
$heroicons = $viewModels->require(HeroiconsOutline::class);

/** @var ProductListItem $productListItemViewModel */
$productListItemViewModel = $viewModels->require(ProductListItem::class);

$uniqueId = '_' . uniqid('');

$viewMode = 'grid';
$imageDisplayArea = 'category_page_grid';
$showDescription = false;

$swiperUrl = $block->getViewFileUrl('Scandiweb_ContentTypes::js/swiper.min.js');
$swiperCssUrl = $block->getViewFileUrl('Scandiweb_ContentTypes::css/swiper.min.css');

$name = (string) $block->getName();
$isSliderInfinitive = (bool) $block->getIsSliderInfinitive();
$isSliderShowPagination = (bool) $block->getData('is_slider_show_pagination');
$isSliderPaginationProgressbar = (bool) $block->getData('is_slider_pagination_progressbar');
$isSliderShowArrows = (bool) $block->getData('is_slider_show_arrows');

$title = (string) $block->getTitle();
$headingTag = $block->getData('heading_tag') ?: 'h3';
$items = $block->getItems() ?? [];
if (is_object($items) && $items instanceof Iterator) {
    $items = iterator_to_array($items);
}
if (!$itemCount = count($items)) {
    return '';
}

$sliderIndex = 1;
$sliderItemRenderer = $block->getLayout()->getBlock('product_list_item')
    ?: $block->getChildBlock('slider.item.template')
    ?: $block->getLayout()->createBlock(Template::class);

$hideRatingSummary = (bool) $block->getData('hide_rating_summary');
$hideDetails       = (bool) $block->getData('hide_details');

$sliderItemRenderer->setData('hide_details', $hideDetails);
$sliderItemRenderer->setData('hide_rating_summary', $hideRatingSummary);

// The slider item renderer block is often a shared instance.
// If a specific item template is set for this slider, the previously set template must be reset later
// so the item template is only replaced for the one slider it is specified on.
$sharedItemRendererTemplate = null;
$isSharedItemRenderer       = $sliderItemRenderer !== $block->getChildBlock('slider.item.template');
if ($isSharedItemRenderer && $block->getChildBlock('slider.item.template')) {
    $sharedItemRendererTemplate = $sliderItemRenderer->getTemplate();
    $sliderSpecificItemTemplate = $block->getChildBlock('slider.item.template')->getTemplate();
    $sliderItemRenderer->setTemplate($sliderSpecificItemTemplate);
}

// The number of slides visible on the xl breakpoint
$maxVisibleSlides = $block->getData('max_visible') ?? 4;

// Breakpoints for 1 visible slider items on mobile, 2 visible on md, 3 on lg and 4 on xl (see $sliderPageSize).
$defaultSliderItemClasses = 'mr-2 py-1 md:w-1/2 lg:w-1/3 xl:w-1/4';

$sliderSectionClasses = $block->getData('maybe_purged_tailwind_section_classes') ?? 'my-4 text-gray-700 body-font';
$slideItemClasses = $block->getData('maybe_purged_tailwind_slide_item_classes') ?? $defaultSliderItemClasses;

?>
<script>
    'use strict';

    function initSliderComponent<?= $uniqueId ?>() {
        return {
            active: 0,
            itemCount: 0,
            init() {
                if (!window.Swiper) {
                    this.addJsScript();
                    this.addCss();
                } else {
                    this.initializeSwiper();
                }
            },
            addJsScript() {
                const self = this;
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.addEventListener('load', () => {
                    self.initializeSwiper();
                });
                script.src = '<?= $escaper->escapeJs($escaper->escapeHtml($swiperUrl)) ?>';
                document.head.appendChild(script);
            },
            addCss() {
                const link = document.createElement('link');
                link.type = 'text/css';
                link.rel = 'stylesheet';
                link.href = '<?= $escaper->escapeJs($escaper->escapeHtml($swiperCssUrl)) ?>';
                document.head.appendChild(link);
            },
            initializeSwiper() {
                const swiperElement = this.$refs.sliderContainer;

                const swiper = new Swiper(swiperElement, {
                    slidesPerView: 'auto',
                    loop: <?= $isSliderInfinitive ? 'true' : 'false' ?>,
                    mousewheel: {
                        forceToAxis: true
                    },
                    <?php if ($isSliderShowArrows): ?>
                        navigation: {
                            nextEl: '.swiper-button-next<?= $uniqueId ?>',
                            prevEl: '.swiper-button-prev<?= $uniqueId ?>',
                        },
                    <?php endif; ?>
                    <?php if ($isSliderShowPagination && !$isSliderPaginationProgressbar): ?>
                        pagination: {
                            el: '.swiper-pagination<?= $uniqueId ?>',
                            type: 'bullets',
                        },
                    <?php endif; ?>
                    <?php if ($isSliderShowPagination && $isSliderPaginationProgressbar): ?>
                        scrollbar: {
                            el: '.swiper-scrollbar<?= $uniqueId ?>',
                            draggable: true,
                        },
                    <?php endif; ?>
                    breakpoints: {
                        320: {
                            slidesPerView: 2
                        },
                        480: {
                            slidesPerView: 3,
                        },
                        1024: {
                            slidesPerView: 4,
                            spaceBetween: 16
                        }
                    }
                });
            },
        }
    }
</script>
<section
    class="<?= $escaper->escapeHtmlAttr($sliderSectionClasses) ?>"
    x-data="initSliderComponent<?= $uniqueId ?>()"
    role="group"
    aria-roledescription="<?= $escaper->escapeHtmlAttr(__('Carousel')) ?>"
    aria-label="<?= $escaper->escapeHtmlAttr(__('Carousel %1', $title)) ?>"
    :aria-describedby="$id('slider-desc')"
    x-defer="intersect">
    <?php if ($items): ?>
        <div class="relative">
            <?php if ($title): ?>
                <div class="container flex flex-col items-center pt-6 pb-3 mx-auto mb-6 border-b-2
                    border-gray-300 md:flex-row">
                    <<?= /* @noEscape */ $headingTag ?> class="text-2xl font-medium text-gray-900 title-font">
                        <?= $escaper->escapeHtml($title); ?>
                    </<?= /* @noEscape */ $headingTag ?>>
                </div>
            <?php endif; ?>
            <div class="swiper" x-ref="sliderContainer">
                <div class="swiper-wrapper flex">
                    <?php foreach ($items as $product): ?>
                        <div class="swiper-slide flex shrink-0 w-full [&>*]:h-full !h-auto <?= $escaper->escapeHtmlAttr($slideItemClasses) ?>"
                            role="group"
                            aria-label="<?= $escaper->escapeHtmlAttr(__('Item %1', $sliderIndex++)) ?>"
                            :aria-describedby="`slide-desc-<?= $escaper->escapeHtmlAttr($product->getId()) ?>-${$id('slider-id')}`">
                            <?=
                            /** @noEscape */
                            $productListItemViewModel->getItemHtmlWithRenderer(
                                $sliderItemRenderer,
                                $product,
                                $block,
                                $viewMode,
                                ProductReviewRenderer::SHORT_VIEW,
                                $imageDisplayArea,
                                $showDescription
                            ) ?>
                        </div>
                    <?php endforeach; ?>
                </div>
                <?php if ($isSliderShowArrows): ?>
                    <div class="swiper-button-prev swiper-button-prev<?= $uniqueId ?>"></div>
                    <div class="swiper-button-next swiper-button-next<?= $uniqueId ?>"></div>
                <?php endif; ?>
                <?php if ($isSliderShowPagination && !$isSliderPaginationProgressbar): ?>
                    <div class="swiper-pagination swiper-pagination<?= $uniqueId ?> !relative mt-3"></div>
                <?php endif; ?>
                <?php if ($isSliderShowPagination && $isSliderPaginationProgressbar): ?>
                    <div class="swiper-scrollbar swiper-scrollbar<?= $uniqueId ?> !relative mt-3 max-w-1/2"></div>
                <?php endif; ?>
            </div>
            <span id="<?= $escaper->escapeHtmlAttr($name) ?>-slider-end" tabindex="-1"></span>
        </div>
    <?php endif; ?>
</section>
<?php

if ($sharedItemRendererTemplate) {
    $sliderItemRenderer->setTemplate($sharedItemRendererTemplate);
}

?>